pico-8 cartridge // http://www.pico-8.com
version 29
__lua__

-- 2d vector functions
function v2_dot(a,b)
  return a[1]*b[1]+a[2]*b[2]
end

function v2_lerp(a,b,t)
  local t_1=1-t
  return {
    a[1]*t_1+t*b[1],
    a[2]*t_1+t*b[2]
  }
end

function v2_normal(v)
  local d=v2_len(v)
  return {v[1]/d,v[2]/d},d
end

function v2_add(a,b,scale)
  scale=scale or 1
  a[1]+=scale*b[1]
  a[2]+=scale*b[2]
end

-- safe vector len
function v2_len(a)
  local dx,dy=abs(a[1]),abs(a[2])
  local d=max(dx,dy)
  local n=min(dx,dy)/d
  return d*sqrt(n*n + 1)
end

function v2_make(a,b,scale)
  scale=scale or 0
  return {(b[1]-a[1])>>scale,(b[2]-a[2])>>scale}
end


local sel=0
local segments={
  {0,0},{32,32},
  {-50,-20},{45,0}}

local EPSILON=1>>16
function ClosestPtSegmentSegment(p1, q1, p2, q2)
  local scale=8
  local d1,d2=v2_make(p1,q1,scale),v2_make(p2,q2,scale)
  local r=v2_make(p2,p1,scale)

  local a,e,f=v2_dot(d1,d1),v2_dot(d2,d2),v2_dot(d2,r)
  
  -- Check if either or both segments degenerate into points
  if a <= EPSILON and e <= EPSILON then
    -- Both segments degenerate into points
    return 0,0
  end

  local s,t=0,0
  if a <= EPSILON then
    -- First segment degenerates into a point
    t = mid(f / e,0,1) -- s = 0 => t = (b*s + f) / e = f / e
  else
    local c = v2_dot(d1, r)
    if e <= EPSILON then
      -- Second segment degenerates into a point
      s = mid(-c / a, 0, 1) -- t = 0 => s = (b*t - c) / a = -c / a
    else
      -- The general nondegenerate case starts here
      local b = v2_dot(d1, d2)
      local denom = a*e-b*b -- Always nonnegative
      -- If segments not parallel, compute closest point on L1 to L2 and
      -- clamp to segment S1. Else pick arbitrary s (here 0)
      if denom != 0 then
        s = mid((b*f - c*e) / denom, 0, 1)
      else
        s = 0
      end
      -- Compute point on L2 closest to S1(s) using
      -- t = Dot((P1 + D1*s) - P2,D2) / Dot(D2,D2) = (b*s + f) / e
      t = (b*s + f) / e;
      -- If t in [0,1] done. Else clamp t, recompute s for the new value
      -- of t using s = Dot((P2 + D2*t) - P1,D1) / Dot(D1,D1)= (t*b - c) / a
      -- and clamp s to [0, 1]
      if t < 0 then
        t = 0
        s = mid(-c / a, 0, 1)
      elseif t > 1 then
        t = 1
        s = mid((b - c) / a, 0, 1)
      end
    end
  end
  return s,t
end

function _update()
  local dx,dy=0,0
  if(btn(0)) dx=-1
  if(btn(1)) dx=1
  if(btn(2)) dy=1
  if(btn(3)) dy=-1
  if(btnp(4)) sel-=1
  if(btnp(5)) sel+=1

  sel=((sel%4)+4)%4
  segments[sel+1][1]+=dx
  segments[sel+1][2]+=dy
end

local _line={-5,10,32,9}

function _init()
  camera(-64,-64)
end
-- draw a segment a/b
function seg(a,b,col)
  line(a[1],-a[2],b[1],-b[2],col)
end

function _draw()
  cls()

  seg(segments[1],segments[2],5)  
  seg(segments[3],segments[4],2)  
  circ(segments[3][1],-segments[3][2],20,2)
  circ(segments[4][1],-segments[4][2],20,2)

  local selpt=segments[sel+1]
  circfill(selpt[1],-selpt[2],2,11)
  
  local s,t=ClosestPtSegmentSegment(segments[1],segments[2],segments[3],segments[4])

  local c1,c2=v2_lerp(segments[1],segments[2],s),v2_lerp(segments[3],segments[4],t)
  circfill(c1[1],-c1[2],1,8)
  print("s",c1[1]+2,-c1[2],8)
  circfill(c2[1],-c2[2],1,8)
  print("t",c2[1]+2,-c2[2],8)


  local n,d=v2_normal(v2_make(c1,c2))
  if d<20 then
    print("collide",2,2,8)
    local t=d/20
    local c={c1[1]-t*n[1],c1[2]-t*n[2]}
    circfill(c[1],-c[2],1,4)
  end
end


__sfx__
01080000260501e0500000000000000000000000000000000000000000000000000000000000001d0502205000000000000000000000000000000000000000000000000000200502605000000000000000000000
010c0000000000000000000000000c1500a1000000000000000000000000000000000000000000000000f15000000000000000000000000000000000000000000000000000000001315000000000000000000000
011000000f150111500f15012150141501615012150141501a1501c1501d1500d1500d1500d1500f150131501515012150141501415012150161500f1500c1500e1500e15010150111500f1500f1500d1500f150
0004000031660366603766037670336702d67023670196600f6600a66008660076500565008650076400763005630056300462004620036100261002610026000260000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00100000164500b450000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000800000c7500b750077500475007640096200661003600016000060000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__music__
01 00014344
00 01020344

